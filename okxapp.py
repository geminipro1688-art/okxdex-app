# -*- coding: utf-8 -*-
"""OKX é¢¨æ ¼éœ“è™¹æ–°èç”Ÿæˆå™¨

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1WtQAQt3m5A9G3ZNWj9yreiE_4p1X9gLA
"""

import streamlit as st
import requests
from datetime import datetime
import base64
from io import BytesIO
from PIL import Image
from rembg import remove

# === è¨­å®šé é¢ ===
st.set_page_config(
    page_title="éœ“è™¹æ–°èé€Ÿå ±ç”Ÿæˆå™¨",
    page_icon="âš¡",
    layout="wide",
    initial_sidebar_state="expanded"
)

# === å¸¸æ•¸èˆ‡è³‡æ–™ ===
NEON_COLORS = {
    "green": "rgba(74, 222, 128, 1)",
    "purple": "rgba(168, 85, 247, 1)",
    "indigo": "rgba(99, 102, 241, 1)",
    "yellow": "rgba(234, 179, 8, 1)"
}

FOOTER_PRESETS = [
    "é€±æœ«äº¤æ˜“æ€•æ»‘é»ï¼Ÿå¿«ç”¨ OKX Wallet DEX èšåˆï¼Œæœ€å„ªåŒ¯ç‡ä¸€éµæ›ï¼",
    "OKX Wallet æ”¯æ´ç™¾æ¢å…¬éˆï¼Œè·¨éˆäº¤æ˜“ä¸€éµæå®šï¼Œçœæ™‚åˆçœåŠ›ã€‚",
    "Web3 å…¥å£é¦–é¸ OKX Walletï¼Œå®‰å…¨æ¢ç´¢ DeFi èˆ‡ NFT ä¸–ç•Œã€‚",
    "æ“”å¿ƒç§é‘°éºå¤±ï¼ŸOKX MPC éŒ¢åŒ…åŠ©ä½ è¼•é¬†ç®¡ç†ï¼Œè³‡ç”¢å®‰å…¨æ›´å‡ç´šã€‚",
    "OKX Earn æä¾›å¤šå…ƒç†è²¡æ–¹æ¡ˆï¼Œè®“é–’ç½®è³‡ç”¢ä¹Ÿèƒ½ç©©å¥å¢å€¼ã€‚",
    "éš¨æ™‚éš¨åœ°ï¼ŒOKX App è®“ä½ è¼•é¬†æŒæ¡å¸‚å ´è„ˆå‹•ï¼Œäº¤æ˜“å¿«äººä¸€æ­¥ã€‚",
    "OKX Web3 éŒ¢åŒ…ï¼Œèšåˆå…¨ç¶²æµå‹•æ€§ï¼Œæ˜¯ä½ è¡åœŸç‹—çš„æœ€ä½³åˆ©å™¨ã€‚",
    "éˆä¸Šäº¤äº’å¤šç•™å¿ƒï¼Œä¸æ˜é€£çµåƒè¬åˆ¥é»æ“Šï¼",
    "è¡Œæƒ…æ³¢å‹•åŠ‡çƒˆï¼Œåˆç´„é–‹å–®è«‹å‹™å¿…è¨­ç½®æ­¢æã€‚",
    "ç§é‘°åŠ©è¨˜è©ä¸é›¢èº«ï¼Œè³‡ç”¢å®‰å…¨è‡ªå·±æŒæ¡ã€‚",
    "Gas Fee æ³¢å‹•å¤§ï¼Œå»ºè­°é¿é–‹å£…å¡æ™‚æ®µæ“ä½œã€‚",
    "DEX äº¤æ˜“é›–ç„¶è‡ªç”±ï¼Œä½†ä¹Ÿåˆ¥å¿˜äº†é ç•™ Gas è²»ã€‚",
    "DeFi æŒ–ç¤¦é«˜æ”¶ç›Šä¼´éš¨é«˜é¢¨éšªï¼Œç„¡å¸¸æå¤±è¦ç²¾ç®—ã€‚",
    "è·¨éˆæ©‹é¸æ“‡å¤šï¼Œç›¡é‡é¸æ“‡å®˜æ–¹æ©‹æ¨‘æœ€ç©©å¦¥ã€‚",
    "è¿·å› å¹£æ³¢å‹•åŠ‡çƒˆï¼ŒæŠ•è³‡å‰è«‹åšå¥½åŠŸèª² (DYOR)ã€‚",
    "ç‰›å¸‚ä¸è¨€é ‚ï¼Œç†Šå¸‚ä¸è¨€åº•ï¼Œå®šæœŸå®šé¡æœ€å®‰å¿ƒã€‚",
    "é€±æœ«æµå‹•æ€§è¼ƒå·®ï¼Œå¤§é¡äº¤æ˜“è«‹æ³¨æ„æ»‘é»è¡æ“Šã€‚"
]

# === Helper Functions ===

def remove_background(image_data):
    """ä½¿ç”¨ rembg ç§»é™¤èƒŒæ™¯"""
    try:
        input_image = Image.open(BytesIO(image_data))
        output_image = remove(input_image)
        buffered = BytesIO()
        output_image.save(buffered, format="PNG")
        return base64.b64encode(buffered.getvalue()).decode()
    except Exception as e:
        st.error(f"å»èƒŒå¤±æ•—: {e}")
        return base64.b64encode(image_data).decode()

def get_coingecko_image(query):
    """æœå°‹ CoinGecko ä¸¦å›å‚³åœ–ç‰‡ URL"""
    try:
        url = f"https://api.coingecko.com/api/v3/search?query={query}"
        response = requests.get(url, timeout=5)
        data = response.json()
        if data.get('coins'):
            coin = data['coins'][0]
            return coin.get('large') or coin.get('thumb')
    except Exception as e:
        st.warning(f"CoinGecko API é€£ç·šéŒ¯èª¤: {e}")
    return None

def download_image_as_base64(url, do_remove_bg=False):
    """ä¸‹è¼‰åœ–ç‰‡ä¸¦è½‰ç‚º Base64ï¼Œå¯é¸æ˜¯å¦å»èƒŒ"""
    try:
        response = requests.get(url, timeout=5)
        if response.status_code == 200:
            if do_remove_bg:
                return remove_background(response.content)
            else:
                return base64.b64encode(response.content).decode()
    except Exception:
        pass
    return None

# === å´é‚Šæ¬„ï¼šç·¨è¼¯å€ ===
with st.sidebar:
    st.header("âš¡ ç·¨è¼¯é¢æ¿")

    with st.expander("ğŸ“… å…¨åŸŸè¨­å®š", expanded=True):
        col1, col2 = st.columns([2, 1])
        main_title = col1.text_input("ä¸»æ¨™é¡Œ", "DEX é€Ÿå ±")
        date_str = col2.text_input("æ—¥æœŸ", datetime.now().strftime("%m/%d"))
        sub_title = st.text_input("å‰¯æ¨™é¡Œ", "ç¤¾ç¾¤å°ç·¨ç¨å®¶æ•´ç†")

    news_data = []

    # ç”Ÿæˆ 4 å‰‡æ–°èçš„è¼¸å…¥æ¡†
    for i in range(4):
        with st.expander(f"ğŸ“° æ–°è #{i+1}", expanded=False):
            title = st.text_input(f"æ¨™é¡Œ #{i+1}", key=f"title_{i}")
            content = st.text_area(f"å…§æ–‡ #{i+1}", key=f"content_{i}", height=100)

            # ä»£å¹£åœ–ç‰‡è¨­å®š
            col_t1, col_t2 = st.columns([3, 1])
            token_query = col_t1.text_input(f"ä»£å¹£åç¨± (ä¾‹å¦‚ BTC) #{i+1}", key=f"token_{i}")
            auto_fetch = col_t2.button("ğŸ” æŠ“åœ–", key=f"btn_{i}")

            # ç‹€æ…‹ç®¡ç† (Session State for image url)
            img_key = f"img_url_{i}"
            if img_key not in st.session_state:
                st.session_state[img_key] = ""

            if auto_fetch and token_query:
                found_url = get_coingecko_image(token_query)
                if found_url:
                    st.session_state[img_key] = found_url
                    st.success("æ‰¾åˆ°åœ–ç‰‡ï¼")
                else:
                    st.error("æ‰¾ä¸åˆ°ä»£å¹£")

            # é¡¯ç¤º/ç·¨è¼¯åœ–ç‰‡é€£çµ
            image_url = st.text_input(f"åœ–ç‰‡ç¶²å€ #{i+1}", value=st.session_state[img_key], key=f"input_url_{i}")

            # å»èƒŒé¸é …
            remove_bg_option = st.checkbox("âœ‚ï¸ è‡ªå‹•å»èƒŒ (AI)", value=True, key=f"bg_{i}")

            # ç‹€æ…‹åœ–ç¤ºé¸æ“‡
            status_icon = st.selectbox(
                f"ç‹€æ…‹åœ–ç¤º #{i+1}",
                ["ç„¡", "ä¸Šæ¼² (Bull)", "ä¸‹è·Œ (Bear)", "è­¦å‘Š (Alert)", "é–å€‰ (Lock)", "è§£é– (Unlock)"],
                key=f"status_{i}"
            )

            news_data.append({
                "title": title,
                "content": content,
                "image_url": image_url,
                "remove_bg": remove_bg_option,
                "status": status_icon
            })

    with st.expander("ğŸ“¢ åº•éƒ¨è·‘é¦¬ç‡ˆ", expanded=True):
        selected_preset = st.selectbox("é¸æ“‡å¸¸ç”¨é‡‘å¥", ["è‡ªè¨‚..."] + FOOTER_PRESETS)
        if selected_preset == "è‡ªè¨‚...":
            footer_text = st.text_input("è‡ªè¨‚æ–‡å­—", "One More Thing: ...")
        else:
            footer_text = st.text_input("åº•éƒ¨æ–‡å­—", selected_preset)

# === ä¸»ç•«é¢ï¼šç”Ÿæˆèˆ‡é è¦½ ===

st.title("âš¡ éœ“è™¹æ–°èé€Ÿå ±ç”Ÿæˆå™¨")
st.markdown("å¡«å¯«å·¦å´æ¬„ä½ï¼Œå³å´å°‡å³æ™‚ç”Ÿæˆé è¦½åœ–ã€‚")

if st.button("ğŸš€ ç”Ÿæˆé è¦½åœ– (Generate)", type="primary"):
    with st.spinner("æ­£åœ¨è™•ç†åœ–ç‰‡èˆ‡å»èƒŒä¸­..."):
        # é å…ˆè™•ç†åœ–ç‰‡ Base64
        processed_news = []
        for idx, item in enumerate(news_data):
            img_b64 = None
            if item["image_url"]:
                img_b64 = download_image_as_base64(item["image_url"], item["remove_bg"])

            # æ±ºå®šç‹€æ…‹åœ–ç¤º SVG (ç°¡åŒ–ç‰ˆ)
            status_svg = ""
            status_color = ""
            if item["status"] != "ç„¡":
                if "ä¸Šæ¼²" in item["status"]:
                    status_color = "text-green-400"
                    status_svg = '<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>'
                elif "ä¸‹è·Œ" in item["status"]:
                    status_color = "text-red-400"
                    status_svg = '<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>'
                elif "è­¦å‘Š" in item["status"]:
                    status_color = "text-yellow-400"
                    status_svg = '<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>'
                elif "é–å€‰" in item["status"]:
                    status_color = "text-purple-400"
                    status_svg = '<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>'
                elif "è§£é–" in item["status"]:
                    status_color = "text-pink-400"
                    status_svg = '<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>'

            processed_news.append({
                **item,
                "img_b64": f"data:image/png;base64,{img_b64}" if img_b64 else None,
                "status_svg": status_svg,
                "status_color": status_color,
                "border_color": list(NEON_COLORS.keys())[idx]
            })

        # çµ„åˆ HTML
        html_content = f"""
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
            <style>
                body {{ font-family: 'Noto Sans TC', sans-serif; background: #000; color: white; margin: 0; padding: 20px; }}
                .neon-card {{ background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px); }}
                .border-green {{ border: 1px solid {NEON_COLORS['green']}; box-shadow: 0 0 15px rgba(74, 222, 128, 0.15); }}
                .border-purple {{ border: 1px solid {NEON_COLORS['purple']}; box-shadow: 0 0 15px rgba(168, 85, 247, 0.15); }}
                .border-indigo {{ border: 1px solid {NEON_COLORS['indigo']}; box-shadow: 0 0 15px rgba(99, 102, 241, 0.15); }}
                .border-yellow {{ border: 1px solid {NEON_COLORS['yellow']}; box-shadow: 0 0 15px rgba(234, 179, 8, 0.15); }}
                .text-gradient {{ background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to bottom right, #ffffff, rgba(255,255,255,0.7)); }}
                .glow-text {{ text-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }}
            </style>
        </head>
        <body>
            <div style="width: 800px; height: 800px; background: #000; padding: 32px; position: relative; overflow: hidden; margin: 0 auto;">
                <!-- Top Line -->
                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #4ade80, #a855f7, #ec4899);"></div>

                <!-- Header -->
                <div class="flex items-end justify-between mb-6 pb-4 border-b border-gray-800">
                    <div class="flex items-baseline gap-4">
                        <h1 class="text-4xl font-black text-green-400 tracking-tight glow-text">
                            {main_title} <span class="text-white ml-2 text-3xl font-bold">{date_str}</span>
                        </h1>
                        <div class="h-6 w-[1px] bg-gray-600"></div>
                        <h2 class="text-xl text-white font-medium tracking-wide">{sub_title}</h2>
                    </div>
                </div>

                <!-- Grid -->
                <div class="grid grid-cols-2 gap-4">
                    {''.join([f'''
                    <div class="relative neon-card rounded-2xl p-6 border-{item['border_color']} flex flex-col justify-between h-[280px]">
                        <div class="relative z-10">
                            <h3 class="text-3xl font-bold leading-tight mb-4 text-white">
                                {item['title']}
                            </h3>
                            <p class="text-gray-300 text-xl leading-relaxed font-medium">
                                {item['content']}
                            </p>
                        </div>

                        <div class="absolute bottom-4 right-4 z-0">
                             <div class="flex items-end gap-3">
                                {f'<img src="{item["img_b64"]}" class="w-20 h-20 object-contain drop-shadow-lg">' if item['img_b64'] else ''}

                                {f'<div class="{item["status_color"]} opacity-90">{item["status_svg"]}</div>' if item['status_svg'] and not item['img_b64'] else ''}
                             </div>
                        </div>
                    </div>
                    ''' for item in processed_news])}
                </div>

                <!-- Footer -->
                <div class="mt-6 pt-4 border-t border-gray-800">
                    <div class="flex items-center gap-2">
                        <span class="text-green-400 font-bold text-lg whitespace-nowrap">One More Thing:</span>
                        <p class="text-white text-lg font-medium truncate">{footer_text.replace('One More Thing:', '')}</p>
                    </div>
                    <div class="flex justify-between items-center mt-4 text-gray-500 text-sm">
                         <div class="flex items-center gap-2">
                            <div class="bg-white text-black font-black px-2 py-0.5 text-xs rounded-sm">APP</div>
                            <span class="font-bold tracking-widest text-white">GENERATOR</span>
                         </div>
                         <p>ä»¥ä¸Šå…§å®¹ä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°ï¼ŒæŠ•è³‡æœ‰é¢¨éšªï¼Œå…¥å¸‚éœ€è¬¹æ…ã€‚</p>
                         <div class="flex gap-2">
                            <span>ğŸŒ</span>
                         </div>
                    </div>
                </div>
            </div>
        </body>
        </html>
        """

        # é¡¯ç¤ºçµæœ
        st.components.v1.html(html_content, height=850, scrolling=True)
        st.info("æç¤ºï¼šæ‚¨å¯ä»¥ç›´æ¥å°ä¸Šæ–¹é è¦½åœ–é€²è¡Œã€Œå³éµ -> å¦å­˜åœ–ç‰‡ã€æˆ–ä½¿ç”¨æˆªåœ–å·¥å…·ä¿å­˜ã€‚")
